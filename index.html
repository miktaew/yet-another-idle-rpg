<HTML>
    <head>
        <link rel = "stylesheet" href = "style.css">
        <script type="module" src = "scripts/main.js"> </script>

        <!--Icons-->
        <script src="https://kit.fontawesome.com/7c8e6b68aa.js" crossorigin="anonymous"></script>

        <!--favicon-->
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        
        
        <Title>Yet Another Idle RPG</Title>
    </head>

    <body onload = "prepareGame()">
        <!-- tooltip for active character effects, couldnt make it to display on top when placed where it should be, so it's here instead-->
        <div id = "effects_tooltip"> 
            No active effects            
        </div>

        <div id = "main_content">
            <!-- basic character info (name, title, hp)-->
            <div id = "basic_character_info_div" class = "box_div">
                <div id = "character_name_div"> 
                    <input type = "text" id = "character_name_field"> 
                </div>
                <div id = "character_title_div">
                    <!-- placeholder for future -->
                </div>

                <div id = "character_health_div"> 
                    <div id = "character_health_text">Health</div>
                    <div id = "character_healthbar_max"> 
                        <div id = "character_healthbar_current">
                        </div>
                    </div>
                    <div id = "character_health_value">
                    </div>
                </div>
                <div id = "character_xp_div">
                    <div id = "character_level_div">
                        Lvl: 0
                    </div>
                    <div id ="character_xp_bar_max">
                        <div id = "character_xp_bar_current">
                            
                        </div>
                    </div>
                    <div id = "character_xp_value">
                    </div>
                </div>
            </div>
            <!-- character stats and equipment-->
            <div id = "character_div" class = "box_div"> 
                <div id = "character_stats_div"> 
                    <div class = "grid_container">
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Strength: </div>
                            <div class = "stat_value" id = "strength_slot"></div> 
                            <span class = "stat_tooltip"> Your strength. It affects power of physical attacks </span>
                        </div>
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Agility: </div>
                            <div class = "stat_value" id = "agility_slot"></div> 
                            <span class = "stat_tooltip"> Your agility. It affects your evasion chance </span>
                        </div>
                    </div>
                    <div class = "grid_container">
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Dexterity: </div>
                            <div class = "stat_value" id = "dexterity_slot"></div> 
                            <span class = "stat_tooltip"> Your dexterity. It affects your chance to hit target </span>
                        </div>
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Atk spd: </div>
                            <div class = "stat_value" id = "attack_speed_slot"></div> 
                            <span class = "stat_tooltip"> Your attack speed. If it's higher than your enemy's, you will sometimes attack more than once per turn </span>
                        </div>
                    </div>
                    <div class = "grid_container">
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Atk power: </div>
                            <div class = "stat_value" id = "attack_power_slot"></div> 
                            <span class = "stat_tooltip"> Attack power. Based on weapon statistics, strength and/or magic </span>
                        </div>
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Defense: </div>
                            <div class = "stat_value" id = "defense_slot"></div> 
                            <span class = "stat_tooltip"> Your defense. Based on worn equipment, lowers damage taken </span>
                        </div>
                        
                    </div>
                    <div class = "grid_container">
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Magic: </div>
                            <div class = "stat_value" id = "magic_slot"></div> 
                            <span class = "stat_tooltip"> Your magic power. It affects damage of magic attacks </span>
                        </div>
                        <div class = "stat_slot_div" id ="unused_stat_div"> 
                            <div class = "stat_name">  </div>
                            <div class = "stat_value" id = "unusued_slot"></div> 
                            <span class = "stat_tooltip"> Maybe something will be here </span>
                        </div>
                    </div>
                    <div class = "grid_container">
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Crit rate: </div>
                            <div class = "stat_value" id = "crit_rate_slot"></div> 
                            <span class = "stat_tooltip"> Your chance for critical attack </span>
                        </div>
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Crit mult: </div>
                            <div class = "stat_value" id = "crit_multiplier_slot"></div> 
                            <span class = "stat_tooltip"> Damage of your critical attacks </span>
                        </div>
                    </div>
                    <div class = "grid_container">
                        <div class = "stat_slot_div"> 
                            <div class = "stat_name"> Hit chance: </div>
                            <div class = "stat_value" id = "hit_chance_slot"></div> 
                            <span class = "stat_tooltip"> Your chance to hit opponent. Based on yours and opponent's agility </span>
                        </div>
                        <div class = "stat_slot_div" id = "defensive_action_chance"> 
                            <div class = "stat_name" id = "defensive_action_slot"> </div>
                            <div class = "stat_value" id = "defensive_action_chance_slot"></div> 
                            <span class = "stat_tooltip"> Your chance for defensive action </span>
                        </div>
                    </div>

                    <div id = "effects_div">
                        <div class = "effects_div"> Active effects: </div>
                        <div class = "effects_div" id = "active_effect_count"> 0 </div>
                    </div>
                </div>

                <div id = "character_equipment_div"> 
                    <div class = "grid_container">
                        <div class = "equipment_slot_div" id = "head_slot"> head </div>
                        <div class = "equipment_slot_div" id = "torso_slot"> torso </div>
                    </div>
                    <div class = "grid_container">
                        <div class = "equipment_slot_div" id = "arms_slot"> arms </div>
                        <div class = "equipment_slot_div" id = "ring_slot"> ring </div>
                    </div>
                    <div class = "grid_container">
                        <div class = "equipment_slot_div" id = "weapon_slot"> weapon </div>
                        <div class = "equipment_slot_div" id = "offhand_slot"> off-hand </div>
                    </div>
                    <div class = "grid_container">
                        <div class = "equipment_slot_div" id = "legs_slot"> legs </div>
                        <div class = "equipment_slot_div" id = "feet_slot"> feet </div>
                    </div>
                    <div class = "equipment_slot_div amulet_slot_div" id = "amulet_slot"> amulet </div>
                </div>

                <div id = "character_control_div">
                    <div id = "character_show_stats" class = "character_control_button active_selection_button" onclick = "showCharacterStats()"> Stats </div>
                    <div id = "character_show_equipment" class = "character_control_button" onclick = "showCharacterEquipment()"> Equipment </div>
                </div>
            </div>
                
            <!-- location info (name, type[safe/combat], weather, time, etc?)-->
            <div id = "location_div" class = "box_div"> 
                <div id = "location_data_div" >
                    <div id = "location_name_div"></div>
                    <div id = "location_description_div"></div>	
                </div>
                <div id = "time_div"> </div>

                <div id = "enemy_info_div">
                    <div id = "enemy_name_div">
                    </div>
                    <div id = "enemy_health_div"> 
                        <div id = "enemy_healthbar_max"> 
                            <div id = "enemy_healthbar_current">
                            </div>
                        </div>
                        <div id = "enemy_health_value">
                        </div>
                        <div id = "enemy_stats_div">
                        </div>
                    </div>
                </div>
                <div id = "enemy_count_div">
                    <div id = "enemy_count_content">
                        <div style = "display:inline-block;"> 
                            Enemies left: 
                        </div>
                        <div id = "enemies_left_div">
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- inventory list -->
            <div id = "inventory_div" class = "box_div"> 
                <div id = "money_div">  </div>
                <div id = "inventory_content_div"> </div>

                <div id = "inventory_sorting_div">
                    <div id = "inventory_sort_by_name" class = "character_sorting_button active_selection_button" onclick='sortCharacterInventory("name")'> Sort by name </div>
                    <div id = "inventory_sort_by_price" class = "character_sorting_button" onclick='sortCharacterInventory("price")'> Sort by price </div>
                </div>
                <div id = "inventory_control_div">
                    <div id = "inventory_show_all" class = "inventory_control_button active_selection_button" onclick = "showAllItems()"> All </div>
                    <div id = "inventory_show_equipment" class = "inventory_control_button" onclick = "showOnlyEquipment()"> Equipment </div>
                    <div id = "inventory_show_consumable" class = "inventory_control_button" onclick = "showOnlyConsumables()"> Usable </div>
                    <div id = "inventory_show_other" class = "inventory_control_button" onclick = "showOnlyOther()"> Other </div> 
                </div>
            </div>


                
            <!-- actions and stuff-->
            <div id = "action_selection_div" class = "box_div">
                <div id = "location_related_div">
                    <div id = "location_actions_div" class = "actions_div">	
                        
                    </div>

                    <div id = "trade_div">
                        <div id = "trader_sorting_buttons"> 
                            <div id = "trader_sort_by_name" class = "trader_sorting_button active_selection_button" onclick='sortTraderInventory("name")'>
                                Sort by name
                            </div>
                            <div id = "trader_sort_by_price" class = "trader_sorting_button" onclick='sortTraderInventory("price")'>
                                Sort by price
                            </div>
                        </div>
                        <div id = "trader_category_buttons">
                            <div id = "trader_category_all" class = "trader_category_button active_selection_button" onclick='showAllTraderItems()'>
                                all
                            </div>
                            <div id = "trader_category_equipment" class = "trader_category_button" onclick="showOnlyTraderEquipment()">
                                equipment
                            </div>
                            <div id = "trader_category_usable" class = "trader_category_button" onclick="showOnlyTraderConsumables()">
                                usable
                            </div>
                            <div id = "trader_category_other" class = "trader_category_button" onclick="showOnlyTraderOther()">
                                other
                            </div>
                        </div>


                        <div id = "trader_inventory_div" class = "actions_div">

                        </div>
                        <div id = "trade_control_div">

                            <div id = "trader_cost_mult">
                                <div id = "trader_cost_mult_text"> Prices: </div>
                                <div id = "trader_cost_mult_value"> </div>
                            </div>
                            
                            <div id = "trade_price_div">
                                <div id = "trade_price_text"> Total cost: </div>
                                <div id = "trade_price_value"> 0C </div>
                            </div>

                            <div id = "accept_trade_button" onclick = "acceptTrade()">
                                Accept
                            </div> 
                            <div id = "cancel_trade_button" onclick = "cancelTrade()">
                                Cancel
                            </div> 
                            <div id = "exit_trade_button" onclick = "exitTrade()">
                                Exit
                            </div>
                        </div>
                    </div>
                 </div>

                <div id = "skill_list_div" class = "actions_div">
                    
                </div>

                <div id = "journal_div" class = "actions_div">
                    Here will be journal (maybe?)
                </div>

                <div id = "action_control_div">
                    <div id = "show_location_actions_div" class = "action_selection_button active_selection_button" onclick = "showLocationActions()"> Location </div>
                    <div id = "show_skills_div" class = "action_selection_button" onclick = "showSkills()"> Skills </div>
                    <div id = "show_journal_div" class = "action_selection_button" onclick = "showJournal()"> Journal </div>
                </div>
            </div>
            

            <!-- message log -->
            <div id = "message_log_div" class = "box_div">
            </div>
        </div>

        <div id = "bottom_panel_div">
            <div id = "save_button" class = "sl_button" onclick = "saveProgress()"> Save </div>
            <div id = "save_to_file_button" class = "sl_button" onclick = "saveToFile()"> Export </div>
            <label id = "load_from_file_button" class = "sl_button" for = "saved_file_input"> Import </label> 
            <input id = "saved_file_input" type='file' accept = 'text/plain' onchange = 'loadProgress(event)'>	
            <div id = "hard_reset_button" class = "sl_button" onclick = "hardReset()"> Hard reset </div>
            
        </div>

        <button id = "test_button">click me</button>


        <script>
            
            function showAllItems() {
                document.documentElement.style.setProperty('--equipment_display', 'initial');
                document.documentElement.style.setProperty('--consumables_display', 'initial');
                document.documentElement.style.setProperty('--other_display', 'initial');
            }
            function showOnlyEquipment() {
                document.documentElement.style.setProperty('--equipment_display', 'initial');
                document.documentElement.style.setProperty('--consumables_display', 'none');
                document.documentElement.style.setProperty('--other_display', 'none');
            }
            function showOnlyConsumables() {
                document.documentElement.style.setProperty('--equipment_display', 'none');
                document.documentElement.style.setProperty('--consumables_display', 'initial');
                document.documentElement.style.setProperty('--other_display', 'none');

            }
            function showOnlyOther() {
                document.documentElement.style.setProperty('--equipment_display', 'none');
                document.documentElement.style.setProperty('--consumables_display', 'none');
                document.documentElement.style.setProperty('--other_display', 'initial');
            }

            function showAllTraderItems() {
                document.documentElement.style.setProperty('--trader_equipment_display', 'block');
                document.documentElement.style.setProperty('--trader_consumable_display', 'block');
                document.documentElement.style.setProperty('--trader_other_display', 'block');
            }
            function showOnlyTraderEquipment() {
                document.documentElement.style.setProperty('--trader_equipment_display', 'block');
                document.documentElement.style.setProperty('--trader_consumable_display', 'none');
                document.documentElement.style.setProperty('--trader_other_display', 'none');
            }
            function showOnlyTraderConsumables() {
                document.documentElement.style.setProperty('--trader_equipment_display', 'none');
                document.documentElement.style.setProperty('--trader_consumable_display', 'block');
                document.documentElement.style.setProperty('--trader_other_display', 'none');
            }
            function showOnlyTraderOther() {
                document.documentElement.style.setProperty('--trader_equipment_display', 'none');
                document.documentElement.style.setProperty('--trader_consumable_display', 'none');
                document.documentElement.style.setProperty('--trader_other_display', 'block');
            }
            

            function showCharacterStats() {
                document.getElementById("character_equipment_div").style.display = "none";
                document.getElementById("character_stats_div").style.display = "grid";
            }
            function showCharacterEquipment() {
                document.getElementById("character_equipment_div").style.display = "grid";
                document.getElementById("character_stats_div").style.display = "none";
            }

            function showLocationActions() {
                document.getElementById("location_related_div").style.display = "block";
                document.getElementById("skill_list_div").style.display = "none";
                document.getElementById("journal_div").style.display = "none";
            }
            function showSkills() {
                document.getElementById("location_related_div").style.display = "none";
                document.getElementById("skill_list_div").style.display = "block";
                document.getElementById("journal_div").style.display = "none";
            }
            function showJournal() {
                document.getElementById("location_related_div").style.display = "none";
                document.getElementById("skill_list_div").style.display = "none";
                document.getElementById("journal_div").style.display = "block";
            }

            var in_trade = false;
            var total_price;
            const trade_price_value = document.getElementById("trade_price_value");
            var trader_sorting = "name";
            var character_sorting = "name";

            function check_trade_cost() {
                const accept_button = document.getElementById("accept_trade_button");
                if(total_price + get_character_money() < 0) { //can't afford
                    accept_button.style.cursor = "no-drop";
                    accept_button.style.backgroundColor = "rgba(0, 128, 0, 0.3)";
                    
                    return false;
                } else {
                    accept_button.style.cursor = "pointer";
                    accept_button.style.backgroundColor = "green";

                    return true;
                }
            }
            
            function startTrade(trader_key) {
                in_trade = true;
                total_price = 0;
                trade_price_value.innerHTML = format_money(total_price);
                document.documentElement.style.setProperty('--trade_ammount_button_display', 'inline_block');
                document.documentElement.style.setProperty('--item_use_button_display', 'none');
                document.documentElement.style.setProperty('--item_other_width', '291px');
                start_trade(trader_key);
            }
            function exitTrade() {
                in_trade = false;
                total_price = 0;
                trade_price_value.innerHTML = format_money(total_price);
                document.documentElement.style.setProperty('--trade_ammount_button_display', 'none');
                document.documentElement.style.setProperty('--item_use_button_display', 'inline-block');
                document.documentElement.style.setProperty('--item_other_width', '340px');

                const accept_button = document.getElementById("accept_trade_button");
                accept_button.style.cursor = "pointer";
                accept_button.style.backgroundColor = "green";

                exit_trade();
            }

            function cancelTrade() {
                total_price = 0;
                trade_price_value.innerHTML = format_money(total_price);

                const accept_button = document.getElementById("accept_trade_button");
                accept_button.style.cursor = "pointer";
                accept_button.style.backgroundColor = "green";

                cancel_trade();
            }

            function acceptTrade() {
                if(check_trade_cost()) {
                    total_price = 0;
                    trade_price_value.innerHTML = format_money(total_price);
                    accept_trade();
                } else {
                    console.log("You can't afford this");
                }
            }


            function sortTraderInventory(option) {
                trader_sorting = option;
                sort_displayed_inventory({sort_by: option, target: "trader"});
            }

            function sortCharacterInventory(option) {
                character_sorting = option;
                sort_displayed_inventory({sort_by: option, target: "character"})
            }

            
            function saveToFile() {
                var a = window.document.createElement('a');
                a.href = window.URL.createObjectURL(new Blob([save_to_file()], {type: 'text/plain'}));
                const date = new Date();
                const year = date.getFullYear();
                const month = date.getMonth() > 9 ? date.getMonth().toString() : "0" + date.getMonth().toString();
                const day = date.getDay() > 9 ? date.getDay().toString() : "0" + date.getDay().toString();
                const hour = date.getHours() > 9 ? date.getHours().toString() : "0" + date.getHours().toString();
                const minute = date.getMinutes() > 9 ? date.getMinutes().toString() : "0" + date.getMinutes().toString();
                const second = date.getSeconds() > 9 ? date.getSeconds().toString() : "0" + date.getSeconds().toString();
                a.download = `yet-another-idle-rpg ${year}-${month}-${day} ${hour}_${minute}_${second}.txt`;

                document.body.appendChild(a);
                a.click();

                document.body.removeChild(a);
            }

            function saveProgress() {
                save_to_localStorage(true);
            }

            function loadProgress(event) {
                    var input = event.target;
                    var reader = new FileReader();

                    reader.onload = function() {
                        load_progress(reader.result);
                    };
                    reader.readAsText(input.files[0]);
            };

            function hardReset() {
                var confirmation = prompt(`If you are sure, type "yes" below`);

                if(confirmation === "yes" || confirmation === `"yes"`) {
                    localStorage.removeItem("save data");
                    window.location.reload();
                    return false;
                }
                else {
                    console.log("Hard reset was cancelled");
                }
            }

            

            function prepareGame() { //called on body loaded
                //sets up event listeners

                //(un)equipping items:
                const inventory_div = document.getElementById("inventory_div");
                inventory_div.onclick = function(event) {
                    var clicked_element = event.target;
                    if(clicked_element.classList.contains("equip_item_button")) {
                        var last_index = clicked_element.parentNode.getAttribute("data-character_item").lastIndexOf(" #"); 
                        //always ends with " #number", so this will get index of that whitespace before "#"

                        equip_item({name: clicked_element.parentNode.getAttribute("data-character_item").substr(0, last_index), 
                                    id: clicked_element.parentNode.getAttribute("data-character_item").substr(last_index+2)
                        });
                    }
                    else if(clicked_element.classList.contains("unequip_item_button")) {
                        var last_index = clicked_element.parentNode.getAttribute("data-character_item").lastIndexOf(" #"); 
                        //always ends with " #slot", so this will get index of that whitespace before "#"

                        unequip_item(clicked_element.parentNode.getAttribute("data-character_item").substr(last_index+2));
                    }
                }

                const tooltip_margin = Number(getComputedStyle(document.querySelector('.item_tooltip'))["margin-left"].replace("px",""));
                //margin-left of tooltip elements

                //item tooltips
                inventory_div.addEventListener('mousemove', move_item_tooltip, false);
                function move_item_tooltip(event) {
                    document.documentElement.style.setProperty('--item_tooltip_top', `${event.pageY - 370}px`);
                    document.documentElement.style.setProperty('--item_tooltip_left', `${event.pageX}px`);
                    
                }
                
                //trader item tooltips
                var trader_inventory_div = document.getElementById("trader_inventory_div");
                trader_inventory_div.addEventListener('mousemove', move_trader_item_tooltip, false);
                function move_trader_item_tooltip(event) {
                    if(event.target.id === "trader_inventory_div") {
                        return;
                    }

                    //set vertical position
                    document.documentElement.style.setProperty('--item_tooltip_top', `${event.pageY - 370}px`);

                    //stuff below: set horizontal position and make sure it doesn't go offscreen if screen width is too small

                    var hovered_element = event.target;
                    if(!hovered_element.classList.contains("trader_item_control")){
                        if(hovered_element.classList.contains("trade_ammount_button") || hovered_element.classList.contains("trader_item")) {
                            hovered_element = hovered_element.parentNode;
                        } else if(hovered_element.classList.contains("inventory_item_name")  || hovered_element.classList.contains("item_tooltip")) {
                            hovered_element = hovered_element.parentNode.parentNode;
                        } else if(hovered_element.parentNode.classList.contains("item_tooltip")) {
                            hovered_element = hovered_element.parentNode.parentNode.parentNode;
                        }
                    }
                    const tooltip_width = hovered_element.children[0].children[1].offsetWidth;
                    
                    const edge_position = window.innerWidth - tooltip_width - tooltip_margin + window.scrollX;

                    if(event.pageX > edge_position) {
                        document.documentElement.style.setProperty('--item_tooltip_left', `${edge_position - 370}px`);
                    } else {
                        document.documentElement.style.setProperty('--item_tooltip_left', `${event.pageX - 370}px`);
                    }
                }

                trader_inventory_div.addEventListener('mouseenter', (event) => {
                    document.documentElement.style.setProperty('--item_tooltip_top', `${event.pageY - 370}px`);
                    document.documentElement.style.setProperty('--item_tooltip_left', `${event.pageX - 370}px`);
                }); 
                //prevents trader item tooltip from initially appearing in wrong spot on some occassions

                //item slots / worn equipment tooltips
                var equipment_div = document.getElementById("character_equipment_div");
                equipment_div.addEventListener('mousemove', move_equipment_tooltip, false);
                function move_equipment_tooltip(event) {
                    var hovered_element = event.target;
                    if(hovered_element.classList.contains("equipment_slot_div")){
                        hovered_element.children[0].style.left = event.pageX + "px";
                        hovered_element.children[0].style.top = event.pageY - 130 + "px";
                    }
                }

                //unequip item
                equipment_div.onclick = function(event) {
                    var clicked_element = event.target;
                    if(clicked_element.classList.contains("equipment_slot_div") && !clicked_element.classList.contains("equipment_slot_empty"))
                    {
                        unequip_item(clicked_element.id.replace("_slot", ""));

                        clicked_element.children[0].style.left = event.pageX + "px";
                        clicked_element.children[0].style.top = event.pageY + "px";
                    }
                }

                //stats tooltips
                var stats_div = document.getElementById("character_stats_div");
                stats_div.addEventListener('mousemove', move_stat_tooltip, false);
                function move_stat_tooltip(event) {
                    var hovered_element = event.target;
                    if(hovered_element.classList.contains("stat_slot_div")) {
                        hovered_element.children[2].style.left = event.pageX + "px";
                        hovered_element.children[2].style.top = event.pageY - 110 + "px";
                    }
                    else {
                        if(hovered_element.classList.contains("stat_name") || hovered_element.classList.contains("stat_value")) {
                            hovered_element.parentNode.children[2].style.left = event.pageX + "px";
                            hovered_element.parentNode.children[2].style.top = event.pageY - 110 + "px";
                        }
                    }
                }

                //activities tooltips
                const location_actions_div = document.getElementById("location_actions_div");
                location_actions_div.addEventListener('mousemove', move_activity_tooltip, false);
                function move_activity_tooltip(event) {
                    document.documentElement.style.setProperty('--job_tooltip_top', `${event.pageY - 370}px`);
                    document.documentElement.style.setProperty('--job_tooltip_left', `${event.pageX - 370}px`);
                }


                //skill tooltips
                var skills_div = document.getElementById("skill_list_div");
                skills_div.addEventListener('mousemove', move_skill_tooltip, false);
                function move_skill_tooltip(event) {
                    var hovered_element = event.target;

                    if(!hovered_element.classList.contains("skill_div")) {
                        if(hovered_element.classList.contains("skill_bar_max")) {
                            hovered_element = hovered_element.parentNode;
                        } else if(hovered_element.classList.contains("skill_bar_text") || hovered_element.classList.contains("skill_bar_current")) {
                            hovered_element = hovered_element.parentNode.parentNode;
                        } else if(hovered_element.classList.contains("skill_bar_name") || hovered_element.classList.contains("skill_bar_xp")) {
                            hovered_element = hovered_element.parentNode.parentNode.parentNode;
                        } else {
                            return;
                        }
                    } 
                    
                    document.documentElement.style.setProperty('--skill_tooltip_top', `${event.pageY - 340}px`)

                    const tooltip_width = hovered_element.children[0].children[2].offsetWidth;
                    
                    const edge_position = window.innerWidth - tooltip_width - tooltip_margin + window.scrollX;

                    if(event.pageX > edge_position) {
                        document.documentElement.style.setProperty('--skill_tooltip_left', `${edge_position - 360}px`);
                    } else {
                        document.documentElement.style.setProperty('--skill_tooltip_left', `${event.pageX - 360}px`);
                    }

                }

                //active effects tooltip
                const active_effects_div = document.getElementById("effects_div");
                const effects_tooltip = document.getElementById("effects_tooltip");
                active_effects_div.addEventListener('mousemove', move_effects_tooltip, false);
                function move_effects_tooltip(event) {
                    const hovered_element = event.target;
                    effects_tooltip.style.display = "block";
                    if(hovered_element.id === "effects_div" || hovered_element.classList.contains("effects_div")) {
                        effects_tooltip.style.left = event.pageX + "px";
                        effects_tooltip.style.top = event.pageY + 30 + "px";
                    }
                }

                active_effects_div.addEventListener('mouseout', end_effects_tooltip, false);
                function end_effects_tooltip(event) {
                    effects_tooltip.style.display = "none";
                }
                
                var inventory_content_div = document.getElementById("inventory_content_div");
                inventory_content_div.addEventListener('click', useItem, false);
                function useItem(event) {
                    const clicked_element = event.target;
                    if(!clicked_element.classList.contains("item_use_button")) {
                        return;
                    }

                    use_item(clicked_element.parentNode.getAttribute("data-character_item"));
                    update_displayed_inventory(character_sorting);
                }

                //move clicked items to proper list
                inventory_content_div.addEventListener('click', move_character_item, false);
                function move_character_item(event) {
                    if(!in_trade) {
                        return;
                    }
                    var clicked_element = event.target;

                    var number_to_move = 1;

                    //reassignes clicked element to the one with inventory_item_control class 
                    if(!clicked_element.classList.contains("inventory_item_control")) {
                        if(clicked_element.classList.contains("inventory_item")) {
                            clicked_element = clicked_element.parentNode; 
                        } else if(clicked_element.classList.contains("inventory_item_name")) {
                            clicked_element = clicked_element.parentNode.parentNode; 
                        } else if(clicked_element.classList.contains("trade_ammount_button")) {
                            number_to_move = Number(clicked_element.getAttribute("data-trade_ammount"));
                            clicked_element = clicked_element.parentNode; 
                        } else {
                            return;
                        }
                    }

                    if(clicked_element.classList.contains("equipped_item_control")) {
                        console.log("Can't sell equipped items");
                        return;
                    }

                    const selected_item = clicked_element.getAttribute("data-character_item");
                    if(clicked_element.classList.contains("item_to_trade")) {
                        //remove from to buy
                        total_price += remove_from_buying_list({item: selected_item, count: number_to_move});
                    }
                    else {
                        //add to to sell
                        total_price += add_to_selling_list({item: selected_item, count: number_to_move})
                    }

                    update_displayed_trader_inventory(trader_sorting);
                    update_displayed_inventory(character_sorting);

                    trade_price_value.innerHTML = format_money(total_price);
                    check_trade_cost();
                }

                trader_inventory_div.addEventListener('click', move_trader_item, false);
                function move_trader_item(event) {
                    if(!in_trade) {
                        return;
                    }
                    var clicked_element = event.target;

                    var number_to_move = 1;

                    if(!clicked_element.classList.contains("inventory_item_control")) {
                        if(clicked_element.classList.contains("inventory_item")) {
                            clicked_element = clicked_element.parentNode; 
                        } else if(clicked_element.classList.contains("inventory_item_name")) {
                            clicked_element = clicked_element.parentNode.parentNode; 
                        } else if(clicked_element.classList.contains("trade_ammount_button")) {
                            number_to_move = Number(clicked_element.getAttribute("data-trade_ammount"));
                            clicked_element = clicked_element.parentNode; 
                        } else {
                            return;
                        }
                    }

                    const selected_item = clicked_element.getAttribute("data-trader_item");
                    if(clicked_element.classList.contains("item_to_trade")) {
                        //remove from to_sell
                        total_price += remove_from_selling_list({item: selected_item, count: number_to_move});
                    }
                    else {
                        //add to to_buy
                        total_price += add_to_buying_list({item: selected_item, count: number_to_move})
                    }

                    update_displayed_trader_inventory(trader_sorting);
                    update_displayed_inventory(character_sorting);

                    trade_price_value.innerHTML = format_money(total_price);
                    check_trade_cost();
                }

                //set colors for active selection buttons
                document.getElementById("inventory_control_div").addEventListener("click", set_active_button);
                document.getElementById("character_control_div").addEventListener("click", set_active_button);
                document.getElementById("action_control_div").addEventListener("click", set_active_button);
                document.getElementById("trader_sort_by_name").addEventListener("click", set_active_button);
                document.getElementById("trader_sort_by_price").addEventListener("click", set_active_button);
                document.getElementById("inventory_sorting_div").addEventListener("click", set_active_button);
                document.getElementById("trader_category_buttons").addEventListener("click", set_active_button);
                function set_active_button(event) {
                    //based on assumption none of them has child elements
                    //alternatively just give all control buttons some attribute that could be then checked for
                    var clicked_element = event.target;
                    if(clicked_element.children.length == 0) {
                        for(let i = 0; i < clicked_element.parentNode.children.length; i++) {
                            clicked_element.parentNode.children[i].classList.remove("active_selection_button");
                        }
                        clicked_element.classList.add("active_selection_button");
                    }
                }
            }
        </script> 
    </body>
</HTML>